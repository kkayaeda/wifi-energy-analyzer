<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>History</title>

  <!-- Bootstrap CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet" />
  <link href="style.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
<!-- Navbar -->
<nav class="navbar sticky-top bg-body-tertiary shadow">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    
    <!-- Sol: Logo + Menü -->
    <div class="d-flex align-items-center">
      <a href="index.html"> 
        <img src="images/logo.png" class="me-2" height="60" alt="Energy Logo" loading="lazy" style="color: #1f1f1f !important;"/>
      </a>
      <a class="navbar-brand" href="index.html">Wi-Fi Energy Analyzer</a>
      <ul class="navbar-nav d-flex flex-row align-items-center ms-3">
        <li class="nav-item">
          <a class="nav-link" href="energy-chart.html">Energy Chart</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="history.html">History</a>
        </li>
        <li class="nav-item me-3">
          <a class="nav-link" href="about.html">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="contact.html">Contact</a>
        </li>
      </ul>
    </div>

    <!-- Sağ: Dark Mode -->
    <div class="d-flex align-items-center">
      <div class="form-check form-switch me-3" id="darkModeToggle">
        <input class="form-check-input" type="checkbox" id="darkModeSwitch">
        <label class="form-check-label" for="darkModeSwitch">
          <span id="toggleIcon"></span>
        </label>
      </div>
      <div class="vr mx-3 d-none d-md-block"></div>
    </div>
  </div>
</nav>

<div class="container py-4 align-items-end">
  <div class="d-flex justify-content-end mt-3">
    <button class="refresh-history-button" id="updateBtn">
      Refresh
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16">
        <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41m-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9"/>
        <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5 5 0 0 0 8 3M3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9z"/>
      </svg>
    </button>
    &nbsp;
    <!-- From Uiverse.io by vinodjangid07 --> 
    <button id="downloadBtn" class="Btn align-items-center mt-1">
     <svg class="svgIcon" viewBox="0 0 384 512" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"></path></svg>
       <span class="icon2"></span>
     <span class="tooltip">Download</span>
    </button>
  </div>

<div class="fixed-buttons">
<button id="shareBtn" class="button" title="Share">
  <img src="images/share.svg" height="20" alt="Share"/>
  <ul>
    <li>
      <a href="https://www.linkedin.com/in/cemile-eda-kaya-1505e/" target="_blank">
        <img src="images/linkedin-logo.svg" height="30" alt="LinkedIn"/>
      </a>
    </li>
    <li>
      <a href="https://github.com/kkayaeda/wifi-energy-analyzer" target="_blank">
        <img src="images/Github-logo.svg" height="38" alt="GitHub"/>
      </a>
    </li>
    <li>
      <a href="mailto: edakaya.1505@gmail.com" target="_blank">
        <img src="images/gmail-icon-seeklogo.svg" height="35" alt="Instagram"/>
      </a>
    </li>
  </ul>
</button>
<a href="#" class="top">&#8593;</a>
</div>

  <!-- Devices Table -->
  <div class="container py-4">
  <main class="flex-grow-1 d-flex flex-column justify-content-center align-items-center py-4 mb-2">
    <p class="text-end text-center">Devices</p>
  </main>
  </div>
  <div class="table-responsive">
    <table class="table table-bordered table-hover table-rounded" style="border:1px solid #363636; border-radius:1rem; overflow:hidden;" id="deviceTable">
      <thead>
        <tr>
          <th>#</th>
          <th>IP</th>
          <th>MAC</th>
          <th>Device Name</th>
          <th>Connection Time</th>
          <th>Energy (kWh)</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="deviceTableBody">
        <tr><td colspan="7" class="text-center text-muted">No data yet</td></tr>
      </tbody>
    </table>

    <!-- Energy Table -->
    <div class="container py-4">
    <main class="flex-grow-1 d-flex flex-column justify-content-center align-items-center py-4 mb-2">
      <p class="text-end text-center">Energy</p>
    </main>
    </div>
    <table class="table table-bordered table-hover table-rounded" style="border:1px solid #363636; border-radius:1rem; overflow:hidden;" id="energyTable">
      <thead>
        <tr>
          <th>Total Energy (kWh)</th>
          <th>Cost (₺)</th>
          <th>Carbon Emission (kg CO₂)</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="energyTableBody">
        <tr><td colspan="4" class="text-center text-muted">No data yet</td></tr>
      </tbody>
    </table>
  </div>
</div>

<footer class="footer-95942 mt-5">
  <div class="container">
    <div class="row justify-items-start">
      <div class="col-md-4 d-flex align-items-start">
        <img src="images/logo.png" alt="Logo" height="60" class="me-3">
        <p>
          Wi-Fi Energy Analyzer is a tool that allows users to view the energy consumption of the devices connected to Wi-Fi.
        </p>
      </div>
      <div class="col-md-8 d-flex flex-column align-items-end">
        <div class="row">
          <div class="col-sm-6 col-md mb-4 mb-md-0">
            <h4>&nbsp;Menu</h4>
              <ul class="list-unstyled nav-links d-flex mb-3">
              <li class="nav-item"><a href="index.html"class="nav-link px-2 text-body-secondary">Wi-Fi Energy Analyzer</a></li>
              <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">Energy Chart</a></li>
              <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">History</a></li>
              <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">About</a></li>
              <li class="nav-item"><a href="#" class="nav-link px-2 text-body-secondary">Contact</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="row py-3">
      <div class="col-md-12 pb-3">
        <div class="border-top">
        </div>
      </div>
    </div>
    <div class="row align-items-center">
      <div class="col-md-4">
        <ul class="list-unstyled social mb-0 pb-0 nav-left">
        </ul>
      </div>
      <div class="col-md-4 text-center">
        <span class="small">2025</span>
      </div>
      <div class="col-md-4 text-right">
        <ul class="list-unstyled social app mb-0 pb-0 nav-right">
          <li><a href="https://www.linkedin.com/in/cemile-eda-kaya-1505e/"><span class="icon-apple mr-3"></span>LinkedIn</a></li>
          <li><a href="https://github.com/kkayaeda/wifi-energy-analyzer"><span class="icon-play mr-2"></span>GitHub</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>

<!-- Bootstrap JS -->
<script src="js/bootstrap.bundle.min.js"></script>

<!-- App Scripts -->
<script src="java.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- jsPDF + autoTable CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
document.getElementById('downloadBtn').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');

  // --- DEVICE TABLE ---
  const deviceTable = document.getElementById('deviceTable');
  const deviceRows = Array.from(deviceTable.querySelectorAll('tbody tr')).map(tr =>
    Array.from(tr.querySelectorAll('td')).map(td => td.innerText)
  );

  doc.autoTable({
    head: [['#', 'IP', 'MAC', 'Device Name', 'Connection Time', 'Energy (kWh)', 'Date']],
    body: deviceRows,
    startY: 20,
    theme: 'grid',
    headStyles: {
      fillColor: [20, 90, 50],
      textColor: [255, 255, 255],
      fontStyle: 'bold',
      halign: 'center',
      valign: 'middle'
    },
    bodyStyles: {
      halign: 'center',
      valign: 'middle',
      fontSize: 9 // Daha kompakt
    },
    styles: {
      cellPadding: 4 // Daha sıkışık
    }
  });

  // --- ENERGY TABLE ---
  const energyTable = document.getElementById('energyTable');
  const energyRows = Array.from(energyTable.querySelectorAll('tbody tr')).map(tr =>
    Array.from(tr.querySelectorAll('td')).map(td => td.innerText)
  );

  let finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 20;

  doc.autoTable({
    head: [['Total Energy (kWh)', 'Cost (TL)', 'Carbon Emission (kg CO2)', 'Date']],
    body: energyRows,
    startY: finalY,
    theme: 'grid',
    headStyles: {
      fillColor: [20, 90, 50],
      textColor: [255, 255, 255],
      fontStyle: 'bold',
      halign: 'center',
      valign: 'middle'
    },
    bodyStyles: {
      halign: 'center',
      valign: 'middle',
      fontSize: 9 // Daha kompakt
    },
    styles: {
      cellPadding: 4 // Daha sıkışık
    },
    columnStyles: {
      1: { cellWidth: 'auto' },
      2: { cellWidth: 'auto' },
      3: { cellWidth: 'auto' } // Carbon Emission için optimize
    }
  });

  doc.save('history.pdf');
});

</script>




<script>
// LocalStorage fallback key’leri
const LS_DEVICES_KEY = "devicesData";
const LS_ENERGY_KEY = "energyData";

// Devices & Energy yükleme fonksiyonları
async function loadDevices() {
  try {
    const res = await fetch("http://localhost:5000/api/devices");
    const data = await res.json();
    const tbody = document.getElementById("deviceTableBody");
    tbody.innerHTML = "";
    data.forEach((d, index) => {
      const row = `<tr>
        <td>${index+1}</td>
        <td>${d.ip}</td>
        <td>${d.mac}</td>
        <td>${d.device_name}</td>
        <td>${d.connection_time}</td>
        <td>${d.energy}</td>
        <td>${d.date}</td>
      </tr>`;
      tbody.innerHTML = row + tbody.innerHTML;
    });
    // LocalStorage'a JSON olarak kaydet
    localStorage.setItem(LS_DEVICES_KEY, JSON.stringify(data));
  } catch(err) {
    console.warn("API çalışmadı, LocalStorage'dan yükleniyor.", err);
    const saved = localStorage.getItem(LS_DEVICES_KEY);
    if(saved) renderDevicesFromJSON(saved);
  }
}

async function loadEnergy() {
  try {
    const res = await fetch("http://localhost:5000/api/energy");
    let data = await res.json();
    // total_energy veya cost veya co2 tamamen 0 olan satırları at
    data = data.filter(d => parseFloat(d.total_energy) !== 0 || parseFloat(d.cost) !== 0 || parseFloat(d.co2) !== 0);
    const tbody = document.getElementById("energyTableBody");
    tbody.innerHTML = "";
    data.forEach(d => {
      // Eğer tüm değerler 0 ise tabloya ekleme
      if (Number(d.total_energy) === 0 && Number(d.cost) === 0 && Number(d.co2) === 0) return;
      const row = `<tr>
        <td>${d.total_energy}</td>
        <td>${d.cost}</td>
        <td>${d.co2}</td>
        <td>${d.date}</td>
      </tr>`;
      tbody.innerHTML = row + tbody.innerHTML;
    });
    // LocalStorage'a JSON olarak kaydet
    localStorage.setItem(LS_ENERGY_KEY, JSON.stringify(data));
  } catch(err) {
    console.warn("API çalışmadı, LocalStorage'dan yükleniyor.", err);
    const saved = localStorage.getItem(LS_ENERGY_KEY);
    if(saved) {
      let data = JSON.parse(saved);
      data = data.filter(d => parseFloat(d.total_energy) !== 0 || parseFloat(d.cost) !== 0 || parseFloat(d.co2) !== 0);

      const tbody = document.getElementById("energyTableBody");
      tbody.innerHTML = "";
      data.forEach(d => {
        const row = `<tr>
          <td>${d.total_energy}</td>
          <td>${d.cost}</td>
          <td>${d.co2}</td>
          <td>${d.date}</td>
        </tr>`;
        tbody.innerHTML = row + tbody.innerHTML;
      });
    }
  }
}

// LocalStorage render yardımcıları
function renderDevicesFromJSON(jsonStr) {
  try {
    const data = JSON.parse(jsonStr);
    const tbody = document.getElementById("deviceTableBody");
    tbody.innerHTML = "";
    data.forEach((d, index) => {
      const row = `<tr>
        <td>${index+1}</td>
        <td>${d.ip}</td>
        <td>${d.mac}</td>
        <td>${d.device_name}</td>
        <td>${d.connection_time}</td>
        <td>${d.energy}</td>
        <td>${d.date}</td>
      </tr>`;
      tbody.innerHTML = row + tbody.innerHTML;
    });
  } catch(e) {
    console.error("Devices LocalStorage render error:", e);
  }
}

function renderEnergyFromJSON(jsonStr) {
  try {
    const data = JSON.parse(jsonStr);
    const tbody = document.getElementById("energyTableBody");
    tbody.innerHTML = "";
    data.forEach(d => {
      const row = `<tr>
        <td>${d.total_energy}</td>
        <td>${d.cost}</td>
        <td>${d.co2}</td>
        <td>${d.date}</td>
      </tr>`;
      tbody.innerHTML = row + tbody.innerHTML;
    });
  } catch(e) {
    console.error("Energy LocalStorage render error:", e);
  }
}

// Update fonksiyonları
async function updateDevicesTable(){
    try{
        const res = await fetch("/api/devices");
        const data = await res.json();
        const tbody = document.getElementById("deviceTableBody");
        tbody.innerHTML = "";
        if(!data || data.length === 0){
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No data</td></tr>`;
            return;
        }
        data.forEach((d, index) => {
            const row = `<tr>
                <td>${index+1}</td>
                <td>${d.ip}</td>
                <td>${d.mac}</td>
                <td>${d.device_name}</td>
                <td>${d.connection_time}</td>
                <td>${d.energy}</td>
                <td>${d.date}</td>
            </tr>`;
            tbody.innerHTML = row + tbody.innerHTML;
        });
        localStorage.setItem(LS_DEVICES_KEY, JSON.stringify(data));
    }catch(err){
        console.warn("Devices update error, LocalStorage fallback kullanılacak.", err);
        const saved = localStorage.getItem(LS_DEVICES_KEY);
        if(saved) renderDevicesFromJSON(saved);
    }
}

async function updateEnergyTable(){
    try{
        const res = await fetch("/api/energy");
        let data = await res.json();
        data = data.filter(d => parseFloat(d.total_energy) !== 0 || parseFloat(d.cost) !== 0 || parseFloat(d.co2) !== 0);
        const tbody = document.getElementById("energyTableBody");
        tbody.innerHTML = "";
        if(!data || data.length === 0){
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No data</td></tr>`;
            return;
        }
        data.forEach(d => {
            // Eğer tüm değerler 0 ise tabloya ekleme
            if (Number(d.total_energy) === 0 && Number(d.cost) === 0 && Number(d.co2) === 0) return;
            const row = `<tr>
                <td>${d.total_energy}</td>
                <td>${d.cost}</td>
                <td>${d.co2}</td>
                <td>${d.date}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
        localStorage.setItem(LS_ENERGY_KEY, JSON.stringify(data));
    }catch(err){
        console.warn("Energy update error, LocalStorage fallback kullanılacak.", err);
        const saved = localStorage.getItem(LS_ENERGY_KEY);
        if(saved) {
          let data = JSON.parse(saved);
          data = data.filter(d => parseFloat(d.total_energy) !== 0 || parseFloat(d.cost) !== 0 || parseFloat(d.co2) !== 0);

          const tbody = document.getElementById("energyTableBody");
          tbody.innerHTML = "";
          data.forEach(d => {
            const row = `<tr>
              <td>${d.total_energy}</td>
              <td>${d.cost}</td>
              <td>${d.co2}</td>
              <td>${d.date}</td>
            </tr>`;
            tbody.innerHTML = row + tbody.innerHTML;
          });
        }
    }
}

// Sayfa yüklendiğinde ve buton ile çağırma
window.addEventListener("load", () => {
  loadDevices();
  loadEnergy();
  updateDevicesTable();
  updateEnergyTable();
});

document.getElementById("updateBtn").addEventListener("click", () => {
  loadDevices();
  loadEnergy();
  updateDevicesTable();
  updateEnergyTable();
});

setInterval(() => {
  updateDevicesTable();
  updateEnergyTable();
}, 60000);
</script>




</body>
</html>
